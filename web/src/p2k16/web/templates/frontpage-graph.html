<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkins Chart</title>
    <script id="checkins">
      window.checkins = {{ events | tojson | safe }};
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://code.highcharts.com/2.2/highcharts.js" type="text/javascript"></script>
    <script type="text/javascript">

      const getParameterByName = (name, defaultValue) => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name) || defaultValue;
      }

      const getLastXDays = (x) => {
        const days = [];
        const now = new Date();
        for (let i = 0; i < x; i++) {
          const date = new Date();
          date.setDate(now.getDate() - i);
          days.unshift(['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()]);
        }
        return days;
      }

      const buildOptions = (categories, series) => {
        return {
          chart: {
            animation: false,
            renderTo: 'container',
            type: 'line',
            backgroundColor: getParameterByName('backgroundColor', null),
            plotBackgroundColor: getParameterByName('plotBackgroundColor', null)
          },
          credits: {
            enabled: false
          },
          title: {
            text: false
          },
          xAxis: {
            categories: categories,
            labels: {
              enabled: false
            }
          },
          yAxis: {
            title: {
              text: false
            },
            plotLines: [{
              value: 0,
              width: 1,
              color: '#808080'
            }],
            labels: {
              enabled: true
            }
          },
          tooltip: {
            formatter: () => {
              return 'Checkins: ' + this.y;
            }
          },
          legend: {
            enabled: false
          },
          series: [{ name: 'Checkins', data: series }]
        };
      }

      $(document).ready(() => {
        try {
          const rawData = window.checkins || [];
          const series = rawData.slice(-7).map(row => row[1]);
          const categories = getLastXDays(series.length);
          const options = buildOptions(categories, series);
          new Highcharts.Chart(options);
        } catch (error) {
          console.error("Error rendering the chart:", error);
        }
      });
    </script>
  </head>

  <body>
    <div id="container" style="width: 100%; height: 100%"></div>
  </body>

</html>